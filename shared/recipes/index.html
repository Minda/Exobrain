<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipes</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0f0f14;
            --card: #18181f;
            --text: #e4e4e7;
            --muted: #71717a;
            --accent: #22c55e;
            --border: #27272a;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .container { max-width: 720px; margin: 0 auto; }
        h1 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .subtitle { color: var(--muted); font-size: 0.9rem; margin-bottom: 2rem; }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--muted);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border);
        }
        .section-title:first-of-type { margin-top: 0; }
        .recipe {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }
        .recipe-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
        }
        .recipe-title a { color: var(--accent); text-decoration: none; }
        .recipe-title a:hover { text-decoration: underline; }
        .recipe-meta { color: var(--muted); font-size: 0.85rem; margin-bottom: 0.35rem; }
        .recipe-contents { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .recipe-row { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .stars {
            display: inline-flex;
            gap: 2px;
            font-size: 1.25rem;
            line-height: 1;
        }
        .stars button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            color: var(--muted);
            transition: color 0.15s;
        }
        .stars button.filled { color: var(--accent); }
        .stars.hover-1 button:nth-child(1),
        .stars.hover-2 button:nth-child(1), .stars.hover-2 button:nth-child(2),
        .stars.hover-3 button:nth-child(1), .stars.hover-3 button:nth-child(2), .stars.hover-3 button:nth-child(3),
        .stars.hover-4 button:nth-child(1), .stars.hover-4 button:nth-child(2), .stars.hover-4 button:nth-child(3), .stars.hover-4 button:nth-child(4),
        .stars.hover-5 button:nth-child(1), .stars.hover-5 button:nth-child(2), .stars.hover-5 button:nth-child(3), .stars.hover-5 button:nth-child(4), .stars.hover-5 button:nth-child(5) { color: var(--accent); }
        .loading { color: var(--muted); }
        .error { color: #ef4444; margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Recipes</h1>
        <p class="subtitle">General recipe list with sections. List and stars from Notion. Click a star to rate (1–5).</p>
        <div id="list" class="loading">Loading…</div>
        <div id="error" class="error" hidden></div>
    </div>
    <script>
        const listEl = document.getElementById('list');
        const errorEl = document.getElementById('error');

        function showError(msg) {
            errorEl.textContent = msg;
            errorEl.hidden = false;
            listEl.innerHTML = '';
        }

        function renderStars(recipeId, currentStars, onUpdate) {
            const wrap = document.createElement('div');
            wrap.className = 'stars';
            wrap.setAttribute('aria-label', 'Your rating');
            for (let i = 1; i <= 5; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.setAttribute('aria-label', `Rate ${i} star${i > 1 ? 's' : ''}`);
                btn.textContent = '★';
                if (i <= currentStars) btn.classList.add('filled');
                btn.addEventListener('click', () => {
                    onUpdate(i);
                    wrap.querySelectorAll('button').forEach((b, idx) => {
                        b.classList.toggle('filled', idx + 1 <= i);
                    });
                });
                btn.addEventListener('mouseenter', () => {
                    wrap.classList.add('hover-' + i);
                });
                btn.addEventListener('mouseleave', () => {
                    wrap.classList.remove('hover-1', 'hover-2', 'hover-3', 'hover-4', 'hover-5');
                });
                wrap.appendChild(btn);
            }
            return wrap;
        }

        function renderRecipeCard(r) {
            const card = document.createElement('div');
            card.className = 'recipe';
            const titleLink = r.mdPath
                ? `<a href="${encodeURI(r.mdPath)}">${escapeHtml(r.title)}</a>`
                : escapeHtml(r.title);
            card.innerHTML = `
                <div class="recipe-title">${titleLink}</div>
                <div class="recipe-meta">Rating: ${r.rating100}/100</div>
                <div class="recipe-contents">${escapeHtml(r.contents)}</div>
                <div class="recipe-row"></div>
            `;
            const row = card.querySelector('.recipe-row');
            const starsEl = renderStars(r.id, r.stars || 0, (stars) => {
                setStars(r.id, stars).catch((e) => showError(e.message));
            });
            row.appendChild(document.createElement('span'));
            row.firstChild.textContent = 'Your rating: ';
            row.appendChild(starsEl);
            return card;
        }

        async function setStars(recipeId, stars) {
            const res = await fetch(`/recipes/${recipeId}/stars`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stars }),
            });
            if (!res.ok) throw new Error(await res.text());
        }

        async function load() {
            try {
                const res = await fetch('/recipes');
                if (!res.ok) throw new Error(await res.text());
                const recipes = await res.json();
                if (!recipes.length) {
                    listEl.innerHTML = '<p class="loading">No recipes. Run the Notion setup and add rows to the Recipes (Synched) database.</p>';
                    return;
                }
                listEl.innerHTML = '';
                listEl.classList.remove('loading');

                // Group by section (empty string = uncategorized, sort sections: named first, then uncategorized)
                const bySection = new Map();
                for (const r of recipes) {
                    const sec = r.section != null ? String(r.section).trim() : '';
                    if (!bySection.has(sec)) bySection.set(sec, []);
                    bySection.get(sec).push(r);
                }
                const sectionOrder = [...bySection.keys()].sort((a, b) => {
                    if (a === '') return 1;
                    if (b === '') return -1;
                    return a.localeCompare(b);
                });

                for (const section of sectionOrder) {
                    const items = bySection.get(section);
                    const sectionTitle = document.createElement('h2');
                    sectionTitle.className = 'section-title';
                    sectionTitle.textContent = section || 'Uncategorized';
                    listEl.appendChild(sectionTitle);
                    for (const r of items) {
                        listEl.appendChild(renderRecipeCard(r));
                    }
                }
            } catch (e) {
                showError(e.message || 'Failed to load recipes.');
            }
        }

        function escapeHtml(s) {
            if (s == null) return '';
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        load();
    </script>
</body>
</html>
